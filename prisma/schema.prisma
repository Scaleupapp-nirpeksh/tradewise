generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(cuid())
  name                String?
  email               String?
  phone               String    @unique
  phoneVerified       DateTime?
  image               String?
  capitalAmount       Float     @default(100000)
  dailyLossLimit      Float     @default(2000)
  brokerName          String    @default("Groww")
  brokerChargeProfile Json?
  onboardingComplete  Boolean   @default(false)

  // Alert preferences
  smsAlertsEnabled    Boolean   @default(true)
  dailySummaryEnabled Boolean   @default(true)
  morningAiEnabled    Boolean   @default(true)
  priceAlertThreshold Float     @default(1.0)

  // Groww API integration
  growwApiKey         String?
  growwApiSecret      String?
  growwAccessToken    String?
  growwTokenExpiry    DateTime?

  // Guidance
  guidanceProgress    Json?
  suggestionPreferences Json?

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  sessions         Session[]
  trades           Trade[]
  strategies       Strategy[]
  dailySnapshots   DailySnapshot[]
  aiSuggestions    AiSuggestion[]
  alertLogs        AlertLog[]
  goals            TradingGoal[]
  positionAdvice   AiPositionAdvice[]
  stockHoldings    StockHolding[]
  mutualFunds      MutualFund[]
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Otp {
  id        String   @id @default(cuid())
  phone     String
  code      String
  expires   DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone, expires])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum TradeSide {
  BUY
  SELL
}

enum TradeStatus {
  OPEN
  CLOSED
}

enum EmotionTag {
  PLANNED
  FOMO
  REVENGE
  IMPULSE
  CONFIDENT
  UNCERTAIN
}

enum SetupRating {
  A
  B
  C
}

model Trade {
  id            String       @id @default(cuid())
  userId        String
  symbol        String
  exchange      String       @default("NSE")
  side          TradeSide
  quantity      Int
  entryPrice    Float
  exitPrice     Float?
  entryTime     DateTime
  exitTime      DateTime?
  grossPnl      Float?
  netPnl        Float?
  charges       Json?
  targetPrice   Float?
  stopLossPrice Float?
  brokerOrderId String?
  strategyId    String?
  notes         String?      @db.Text
  emotionTag    EmotionTag?
  setupRating   SetupRating?
  status        TradeStatus  @default(OPEN)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategy       Strategy?          @relation(fields: [strategyId], references: [id])
  positionAdvice AiPositionAdvice[]

  @@index([userId, createdAt])
  @@index([userId, status])
}

model Strategy {
  id          String  @id @default(cuid())
  userId      String
  name        String
  description String?

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  trades Trade[]

  @@unique([userId, name])
}

model DailySnapshot {
  id           String   @id @default(cuid())
  userId       String
  date         DateTime @db.Date
  totalTrades  Int      @default(0)
  winners      Int      @default(0)
  losers       Int      @default(0)
  grossPnl     Float    @default(0)
  totalCharges Float    @default(0)
  netPnl       Float    @default(0)
  capitalUsed  Float    @default(0)
  notes        String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

enum SuggestionAction {
  BUY
  SELL
}

enum SuggestionConfidence {
  HIGH
  MEDIUM
  LOW
}

enum SuggestionStatus {
  PENDING
  FOLLOWED
  IGNORED
  EXPIRED
}

model AiSuggestion {
  id                String               @id @default(cuid())
  userId            String
  symbol            String
  action            SuggestionAction
  suggestedEntry    Float
  suggestedTarget   Float
  suggestedStopLoss Float
  reasoning         String               @db.Text
  confidence        SuggestionConfidence
  status            SuggestionStatus     @default(PENDING)
  createdAt         DateTime             @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}

enum AlertType {
  LOSS_LIMIT
  POSITION_ALERT
  AI_SUGGESTION
  DAILY_SUMMARY
}

model AlertLog {
  id        String    @id @default(cuid())
  userId    String
  type      AlertType
  message   String    @db.Text
  channel   String    @default("SMS")
  delivered Boolean   @default(false)
  tradeId   String?
  metadata  Json?
  sentAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, sentAt])
}

// Price cache for server-side caching of stock prices
model PriceCache {
  id        String   @id @default(cuid())
  symbol    String   @unique
  exchange  String   @default("NSE")
  price     Float
  change    Float    @default(0)
  changePct Float    @default(0)
  volume    Int      @default(0)
  source    String   @default("twelve_data")
  updatedAt DateTime @updatedAt

  @@index([symbol])
}

// Trading goals for tracking progress
enum GoalType {
  NET_PNL
  WIN_RATE
  MAX_LOSS_PER_TRADE
  TOTAL_TRADES
  PORTFOLIO_VALUE
  MONTHLY_INVESTMENT
}

enum GoalPeriod {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

model TradingGoal {
  id           String     @id @default(cuid())
  userId       String
  type         GoalType
  targetValue  Float
  period       GoalPeriod
  startDate    DateTime   @db.Date
  endDate      DateTime   @db.Date
  currentValue Float      @default(0)
  achieved     Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, period])
}

// Stock holdings (delivery / long-term)
model StockHolding {
  id            String   @id @default(cuid())
  userId        String
  symbol        String
  exchange      String   @default("NSE")
  quantity      Int
  buyPrice      Float
  buyDate       DateTime
  currentPrice  Float    @default(0)
  notes         String?  @db.Text
  brokerOrderId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, symbol])
  @@index([userId, createdAt])
}

// Mutual fund investments
model MutualFund {
  id             String   @id @default(cuid())
  userId         String
  schemeName     String
  schemeCode     String
  folioNumber    String?
  units          Float
  investedAmount Float
  currentNav     Float    @default(0)
  category       String?
  isSip          Boolean  @default(false)
  sipAmount      Float?
  sipDate        Int?
  notes          String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, schemeCode])
  @@index([userId, createdAt])
}

// NAV cache for mutual funds
model NavCache {
  id         String   @id @default(cuid())
  schemeCode String   @unique
  nav        Float
  date       String
  updatedAt  DateTime @updatedAt

  @@index([schemeCode])
}

// AI position advice (HOLD/SELL/BUY_MORE per position)
enum PositionAction {
  HOLD
  SELL
  BUY_MORE
}

model AiPositionAdvice {
  id           String               @id @default(cuid())
  userId       String
  tradeId      String
  action       PositionAction
  currentPrice Float
  reasoning    String               @db.Text
  confidence   SuggestionConfidence
  createdAt    DateTime             @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  trade Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
}
